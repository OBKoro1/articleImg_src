---
title: vue 项目如何引入微信sdk，使用微信分享接口
date: 2017-12-16 20:46:14
tags:
- Vue
- 微信
categories: Vue
---
写在前面：
---
做微信的网页基本上都要接入微信的sdk，我在做的时候，也颇费了一番功夫，然后就想记录一下，供自己日后翻阅，以及让有需要的朋友可以做一下参考，如果喜欢的可以点波赞，或者关注一下，希望可以帮到大家。

> 本文首发于我的个人blog：[obkoro1.com](http://obkoro1.com/)



### 安装sdk

        npm install weixin-js-sdk --save

开始之前大家可以先读一读微信公众号的 **[接入文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115)**，vue是单页面项目，比如你想要接入微信分享功能，分享功能在每个路由地址都要有，因为每个路由的url是不一样的，搜易就需要在每个路由地址都引入一遍。

## 整体步骤：

1. vue引入sdk的话，就是在路由组件里面的，组件生命周期的：creatd()和mounted()里面放代码。
2. 用伪代码，熟悉一下整体的流程，要做哪些事情：

        //wx是引入的微信sdk
        wx.config('这里有一些参数');//通过config接口注入权限验证配置
        
        wx.ready(function() { //通过ready接口处理成功验证
        // config信息验证成功后会执行ready方法
            wx.onMenuShareAppMessage({ // 分享给朋友  ,在config里面填写需要使用的JS接口列表，然后这个方法才可以用 
                title: '这里是标题', // 分享标题
                desc: 'This is a test!', // 分享描述
                link: '链接', // 分享链接
                imgUrl: '图片', // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function() {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function() {
                    // 用户取消分享后执行的回调函数
                }
                 });
                wx.onMenuShareTimeline({ //分享朋友圈
                title: '标题', // 分享标题
                link: '链接',
                imgUrl: '图片', // 分享图标
                success: function() {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function() {
                    // 用户取消分享后执行的回调函数
                }
            });
        });
         wxx.error(function(res){//通过error接口处理失败验证
            // config信息验证失败会执行error函数
        });

上面的流程多看几遍，对整个流程有个概念，其中最重要的一步就是下面这个借口注入权限。

### config接口注入权限

接入微信接口的最主要也是最重要一步步就是填写下面这些信息，填完这些信息之后，基本就好了。下面这些信息通常是通过后端接口来获取的。

    wx.config({
        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '', // 必填，公众号的唯一标识
        timestamp: , // 必填，生成签名的时间戳
        nonceStr: '', // 必填，生成签名的随机串
        signature: '',// 必填，签名，见附录1
        jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

### 获取config配置信息：

前端要获取上面那些信息，不用做太多东西，只要调后端接口就可以了。后端会把那些信息处理好，然后通过一个接口返给你这些参数。你要给后端传一个**当前路由页面的完整url**，后端就会返回上述的那些信息给你，后面就可以根据自己的需求调用相应的接口，自定义里面的东西。

#### 坑点：url

这里要注意的就是url的问题，如果url没有正确传递，后端也会返回信息，但是签名信息会是错误的。

上面提到的完整url指的是：'http(s)://'部分，以及'？'后面的GET参数部分,但不包括'#'hash后面的部分。可以通过`location.href`来获取。

**注意**： 如果你的vue项目，路由没有开启history 模式,也就是你的url上面包含“#”，这个时候要从后端正确获取签名，就需要**去掉url上#后面的字符**。（url去掉'#'hash部分，可用`location.href.split('#')[0]`）

### 封装调用sdk注入：

因为要在每个路由页面都注入sdk，这个肯定要复用的，不然那么多代码，看着就头大。

#### 我是这么做的：

1. 因为我把axios[包了一层](https://juejin.im/post/59fd982c6fb9a045170490df)，然后把axios接口，在main.js里面挂载到Vue实例。
![](https://user-gold-cdn.xitu.io/2017/12/16/1605f3933091e9d2?w=535&h=98&f=png&s=18864)
2. 然后在[全局函数](https://juejin.im/post/59eddbfe6fb9a0450908abb4)里面调用这个接口，然后在每个路由页面的相应组件里面调用这个函数，把当前页面的url以及其他标题、图片什么的传进去。

里面的具体步骤就不说了，最重要的是参考上面的那个流程，函数里面的东西也都是基于那个流程的。

### 签名校验：

当你反复确认步骤都没有问题，微信sdk注入还是签名失败的时候，这个时候你就要考虑是不是后端那边的算法有问题，可以把后端返回的签名和微信提供的[JS 接口签名校验工具](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign)生成的签名对比一下，或许是后端那边算法的问题也不一定。

后话
---
实不相瞒，当时我做的时候就是被url这个坑了，第一次做这个东西，没有经验，折腾了好久。引入sdk并不难，重要的是那个配置信息要填写正确，然后其他的就根据实际需求来做了。

**最后**：如需转载，请放上原文链接并署名。码字不易，**感谢**支持！本人写文章本着交流记录的心态，写的不好之处，不撕逼，但是欢迎指点。然后就是希望看完的朋友点个**喜欢**，也可以**关注**一下我。
**[个人blog](http://obkoro1.com/)** and **[掘金个人主页](https://juejin.im/user/58714f0eb123db4a2eb95372)**  

以上2017.12.16